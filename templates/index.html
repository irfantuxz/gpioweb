<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.75">
    <title>WebGPIO Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        :root {
            --bg-color: #0b1020;      --text-color: #e6eef8;   --board-bg: #06070a;
            --pin-power5v: #ff6b97;   --pin-power3v: #ff9f4d;  --pin-gnd: #2b2f3a;
            --pin-gpio-off: #3fb0ff;  --pin-gpio-on: #2fd27a;
        }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg-color); color: var(--text-color); display: flex; flex-direction: column; align-items: center; padding: 20px; margin: 0; }
        .subtitle { color: #a6adc8; margin-bottom: 20px; text-align: center; }
        
        /* UI Control Read/Write Mode */
        .controls { margin-bottom: 20px; display: flex; align-items: center; gap: 15px; background: #1a2235; padding: 12px 25px; border-radius: 8px; border: 1px solid #333; }
        .switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #555; transition: .3s; border-radius: 26px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px; background-color: white; transition: .3s; border-radius: 50%; }
        input:checked + .slider { background-color: #ff3b30; }
        input:checked + .slider:before { transform: translateX(24px); }
        .mode-label { font-weight: bold; font-size: 14px; width: 90px; text-align: right; }
        .mode-label.write { color: #ff3b30; }
        .mode-label.read { color: #2fd27a; }

        .board { background-color: var(--board-bg); padding: 30px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .header-j8 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; background-color: #222; padding: 20px; border-radius: 8px; border: 2px solid #333; }
        
        /* Layout Pin */
        .pin { display: flex; align-items: center; justify-content: space-between; width: 280px; padding: 8px 10px; border-radius: 6px; font-size: 13px; font-weight: bold; color: #111; transition: 0.2s; box-sizing: border-box; }
        .pin-left { flex-direction: row; }
        .pin-right { flex-direction: row-reverse; }
        
        .pin .number { font-size: 10px; background: rgba(255,255,255,0.4); padding: 3px 6px; border-radius: 4px; min-width: 14px; text-align: center; }
        .pin .name { flex: 1; text-align: center; padding: 0 5px; }
        .pin .function { font-size: 10px; color: #333; background: rgba(255,255,255,0.3); padding: 3px 6px; border-radius: 4px; width: 85px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .empty-func { visibility: hidden; } /* Menyembunyikan fungsi yang kosong namun mempertahankan spasi */
        
        /* Palet Warna Pin */
        .power-5v { background-color: var(--pin-power5v); } .power-3v { background-color: var(--pin-power3v); }
        .gnd { background-color: var(--pin-gnd); color: white; }
        .gnd .function { background: rgba(255,255,255,0.1); color: #ccc; }
        
        /* State Default (Read Only) */
        .gpio { background-color: var(--pin-gpio-off); cursor: not-allowed; opacity: 0.8; }
        .gpio.on { background-color: var(--pin-gpio-on); box-shadow: none; }
        .reserved { background-color: #7f849c; cursor: not-allowed; }

        /* State Interaktif (Write Mode Aktif) */
        .write-mode .gpio { cursor: pointer; opacity: 1; }
        .write-mode .gpio.on { box-shadow: 0 0 10px var(--pin-gpio-on); }
        .write-mode .gpio:hover { filter: brightness(1.2); transform: scale(1.02); }
    </style>
</head>
<body>
    <h2>{{ model_name }}</h2>
    <div class="subtitle">Interactive Header (SoC: {{ soc_name }} | {{ ram_size }} RAM) via WebSocket</div>
    
    <div class="controls">
        <span id="modeStatus" class="mode-label read">READ ONLY</span>
        <label class="switch">
            <input type="checkbox" id="writeToggle">
            <span class="slider"></span>
        </label>
        <span style="font-size: 12px; color: #a6adc8;">Enable Write State</span>
    </div>

    <div class="board" id="mainBoard">
        <div class="header-j8" id="pin-container"></div>
    </div>

    <script>
        // Pemetaan Fungsi Berdasarkan Tabel Header GPIO Raspberry Pi 40-pin (J8)
        const pinMap = [
            { pin: 1, name: '3V3', type: 'power-3v', bcm: null, func: 'DC power' },     { pin: 2, name: '5V', type: 'power-5v', bcm: null, func: 'DC power' },
            { pin: 3, name: 'GPIO 2', type: 'gpio', bcm: 2, func: 'I2C (SDA)' },         { pin: 4, name: '5V', type: 'power-5v', bcm: null, func: 'DC power' },
            { pin: 5, name: 'GPIO 3', type: 'gpio', bcm: 3, func: 'I2C (SCL)' },         { pin: 6, name: 'GND', type: 'gnd', bcm: null, func: '' },
            { pin: 7, name: 'GPIO 4', type: 'gpio', bcm: 4, func: 'GPCLK0' },            { pin: 8, name: 'GPIO 14', type: 'gpio', bcm: 14, func: 'UART (TXD0)' },
            { pin: 9, name: 'GND', type: 'gnd', bcm: null, func: '' },                   { pin: 10, name: 'GPIO 15', type: 'gpio', bcm: 15, func: 'UART (RXD0)' },
            { pin: 11, name: 'GPIO 17', type: 'gpio', bcm: 17, func: '' },               { pin: 12, name: 'GPIO 18', type: 'gpio', bcm: 18, func: 'PCM CLK (I2S)' },
            { pin: 13, name: 'GPIO 27', type: 'gpio', bcm: 27, func: '' },               { pin: 14, name: 'GND', type: 'gnd', bcm: null, func: '' },
            { pin: 15, name: 'GPIO 22', type: 'gpio', bcm: 22, func: '' },               { pin: 16, name: 'GPIO 23', type: 'gpio', bcm: 23, func: '' },
            { pin: 17, name: '3V3', type: 'power-3v', bcm: null, func: 'DC power' },     { pin: 18, name: 'GPIO 24', type: 'gpio', bcm: 24, func: '' },
            { pin: 19, name: 'GPIO 10', type: 'gpio', bcm: 10, func: 'SPI (MOSI)' },     { pin: 20, name: 'GND', type: 'gnd', bcm: null, func: '' },
            { pin: 21, name: 'GPIO 9', type: 'gpio', bcm: 9, func: 'SPI (MISO)' },       { pin: 22, name: 'GPIO 25', type: 'gpio', bcm: 25, func: '' },
            { pin: 23, name: 'GPIO 11', type: 'gpio', bcm: 11, func: 'SPI (CLK)' },      { pin: 24, name: 'GPIO 8', type: 'gpio', bcm: 8, func: 'SPI (CE0)' },
            { pin: 25, name: 'GND', type: 'gnd', bcm: null, func: '' },                  { pin: 26, name: 'GPIO 7', type: 'gpio', bcm: 7, func: 'SPI (CE1)' },
            { pin: 27, name: 'GPIO 0', type: 'reserved', bcm: 0, func: 'I2C EEPROM' },   { pin: 28, name: 'GPIO 1', type: 'reserved', bcm: 1, func: 'I2C EEPROM' },
            { pin: 29, name: 'GPIO 5', type: 'gpio', bcm: 5, func: '' },                 { pin: 30, name: 'GND', type: 'gnd', bcm: null, func: '' },
            { pin: 31, name: 'GPIO 6', type: 'gpio', bcm: 6, func: '' },                 { pin: 32, name: 'GPIO 12', type: 'gpio', bcm: 12, func: 'PWM0' },
            { pin: 33, name: 'GPIO 13', type: 'gpio', bcm: 13, func: 'PWM1' },           { pin: 34, name: 'GND', type: 'gnd', bcm: null, func: '' },
            { pin: 35, name: 'GPIO 19', type: 'gpio', bcm: 19, func: 'PCM FS (I2S)' },   { pin: 36, name: 'GPIO 16', type: 'gpio', bcm: 16, func: '' },
            { pin: 37, name: 'GPIO 26', type: 'gpio', bcm: 26, func: '' },               { pin: 38, name: 'GPIO 20', type: 'gpio', bcm: 20, func: 'PCM DIN (I2S)' },
            { pin: 39, name: 'GND', type: 'gnd', bcm: null, func: '' },                  { pin: 40, name: 'GPIO 21', type: 'gpio', bcm: 21, func: 'PCM Dout (I2S)' },
        ];

        const container = document.getElementById('pin-container');
        const writeToggle = document.getElementById('writeToggle');
        const modeStatus = document.getElementById('modeStatus');
        const mainBoard = document.getElementById('mainBoard');

        // Logic visual mode toggle
        writeToggle.addEventListener('change', (e) => {
            if(e.target.checked) {
                modeStatus.textContent = 'WRITE MODE';
                modeStatus.className = 'mode-label write';
                mainBoard.classList.add('write-mode');
            } else {
                modeStatus.textContent = 'READ ONLY';
                modeStatus.className = 'mode-label read';
                mainBoard.classList.remove('write-mode');
            }
        });

        // Modifikasi Render Pin untuk 4 Kolom Visual
        pinMap.forEach(p => {
            const div = document.createElement('div');
            const isOdd = p.pin % 2 !== 0; 
            div.className = `pin ${p.type} ${isOdd ? 'pin-left' : 'pin-right'}`; 
            if (p.bcm !== null) div.id = `pin-${p.bcm}`;
            
            const funcHtml = `<span class="function ${p.func ? '' : 'empty-func'}">${p.func || '-'}</span>`;
            
            div.innerHTML = `
                ${funcHtml}
                <span class="name">${p.name}</span>
                <span class="number">${p.pin}</span>
            `;
            
            if (p.type === 'gpio') {
                div.addEventListener('click', () => {
                    // Validasi ganda: Klien hanya emit jika sakelar menyala
                    if (writeToggle.checked) {
                        socket.emit('toggle', { bcm: p.bcm, write_mode: true });
                    }
                });
            }
            container.appendChild(div);
        });

        // --- Koneksi WebSockets ---
        const socket = io();

        // Menggantikan fetch loop dengan event listener real-time
        socket.on('status_update', (status) => {
            for (const [bcm, state] of Object.entries(status)) {
                const el = document.getElementById(`pin-${bcm}`);
                if (el) {
                    state ? el.classList.add('on') : el.classList.remove('on');
                }
            }
        });

        socket.on('connect_error', () => {
            console.warn("Terputus dari WebSocket Server.");
        });

    </script>
</body>
</html>